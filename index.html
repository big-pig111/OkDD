<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gachapon Machine</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Arial Black', Impact, Haettenschweiler, 'Arial', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #f5f5f5;
        }

        /* Full-screen pixelated background canvas */
        #pixelBg {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            display: block;
            image-rendering: pixelated;
            z-index: 0;
        }

        .container {
            text-align: center;
            background: rgba(15, 15, 15, 0.55);
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            backdrop-filter: blur(6px);
            z-index: 2;
        }

        h1 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 2.8em;
            letter-spacing: 0.5px;
            position: relative;
            font-weight: 800;
            text-transform: none;
            font-family: 'Press Start 2P', 'VT323', 'SimHei', 'Microsoft YaHei', Arial, sans-serif;
            -webkit-font-smoothing: none;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeSpeed;
            /* Stronger pixel outline effect */
            text-shadow: 0 1px 0 #000, 1px 0 0 #000, 0 -1px 0 #000, -1px 0 0 #000,
                         1px 1px 0 #000, -1px 1px 0 #000, 1px -1px 0 #000, -1px -1px 0 #000,
                         0 2px 0 #000, 2px 0 0 #000, 0 -2px 0 #000, -2px 0 0 #000;
        }

        /* OKX style title: clean, no shadow, bold */
        .glitch {
            text-shadow: none;
            animation: none;
            letter-spacing: 0.5px;
            font-weight: 800;
        }

        .video-container {
            margin: 20px 0;
            position: relative;
            display: inline-block;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        video {
            max-width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
        }

        /* Cover the theme text in the upper left corner of the video (used to cover watermarks) */
        .video-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 2;
            padding: 6px 12px;
            background: rgba(10,10,10,0.86);
            border: 1px solid rgba(255,255,255,0.16);
            border-radius: 8px;
            color: #ffffff;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-transform: none;
            box-shadow: 0 8px 20px rgba(0,0,0,0.55);
            pointer-events: none;
            font-family: 'Press Start 2P', 'VT323', 'SimHei', 'Microsoft YaHei', Arial, sans-serif;
            -webkit-font-smoothing: none;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeSpeed;
            text-shadow: 0 1px 0 #000, 1px 0 0 #000, 0 -1px 0 #000, -1px 0 0 #000,
                         1px 1px 0 #000, -1px 1px 0 #000, 1px -1px 0 #000, -1px -1px 0 #000,
                         0 2px 0 #000, 2px 0 0 #000, 0 -2px 0 #000, -2px 0 0 #000;
        }

        /* meme captions */
        .meme-caption {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: #ffffff;
            font-size: 1.2em;
            font-weight: 900;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-family: 'Press Start 2P', 'VT323', 'SimHei', 'Microsoft YaHei', Arial, sans-serif;
            -webkit-font-smoothing: none;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeSpeed;
            text-shadow: 0 1px 0 #000, 1px 0 0 #000, 0 -1px 0 #000, -1px 0 0 #000,
                         1px 1px 0 #000, -1px 1px 0 #000, 1px -1px 0 #000, -1px -1px 0 #000,
                         0 2px 0 #000, 2px 0 0 #000, 0 -2px 0 #000, -2px 0 0 #000;
            pointer-events: none;
            padding: 4px 10px;
        }
        .meme-caption.top { top: 8px; display: none; }
        .meme-caption.bottom { bottom: 8px; }

        /* OKX black square style button */
        .gacha-button {
            background: radial-gradient(120% 120% at 30% 30%, #161616 0%, #0f0f0f 60%, #0a0a0a 100%);
            color: #ffffff;
            border: 1px solid rgba(255,255,255,0.12);
            width: 128px;
            height: 128px;
            border-radius: 20px;
            cursor: pointer;
            margin: 16px 0 6px;
            transition: transform 0.2s ease, box-shadow 0.25s ease, border-color 0.25s ease, background 0.25s ease;
            box-shadow: 0 16px 32px rgba(0,0,0,0.55), inset 0 -8px 18px rgba(255,255,255,0.05), inset 0 10px 22px rgba(0,0,0,0.6);
            font-weight: 900;
            letter-spacing: 0.5px;
            font-size: 14px;
            font-family: 'Press Start 2P', 'VT323', 'SimHei', 'Microsoft YaHei', Arial, sans-serif;
            -webkit-font-smoothing: none;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeSpeed;
            text-shadow: 0 1px 0 #000, 1px 0 0 #000, 0 -1px 0 #000, -1px 0 0 #000,
                         1px 1px 0 #000, -1px 1px 0 #000, 1px -1px 0 #000, -1px -1px 0 #000,
                         0 2px 0 #000, 2px 0 0 #000, 0 -2px 0 #000, -2px 0 0 #000;
            position: relative;
            overflow: hidden;
        }
        .gacha-button::before {
            content: "";
            position: absolute; inset: -1px; border-radius: 20px;
            background: linear-gradient(135deg, rgba(176,255,59,0.35), rgba(0,0,0,0) 40%, rgba(176,255,59,0.25));
            filter: blur(6px); opacity: 0; transition: opacity .25s ease;
        }
        .gacha-button::after {
            content: "";
            position: absolute; inset: 0; border-radius: 20px;
            background: radial-gradient(120px 120px at 20% 20%, rgba(255,255,255,0.08), transparent 60%);
            opacity: .6; pointer-events: none;
        }
        .gacha-button:hover {
            transform: translateY(-3px) scale(1.02);
            border-color: rgba(176,255,59,0.45);
            box-shadow: 0 22px 48px rgba(0,0,0,0.6), 0 0 24px rgba(176,255,59,0.18);
        }
        .gacha-button:hover::before { opacity: 1; }
        .gacha-button:active { transform: translateY(0) scale(0.98); }
        .gacha-button.spinning {
            animation: knobSpin 1.2s cubic-bezier(.2,.7,.2,1) infinite;
        }
        @keyframes knobSpin {
            0% { transform: rotate(0deg); }
            40% { transform: rotate(25deg) scale(1.03); }
            60% { transform: rotate(-10deg) scale(1.01); }
            100% { transform: rotate(0deg); }
        }

        .status {
            color: #d6d6d6;
            margin-top: 12px;
            font-size: 0.95em;
            letter-spacing: 0.2px;
            opacity: 0.9;
            font-family: 'Press Start 2P', 'VT323', 'SimHei', 'Microsoft YaHei', Arial, sans-serif;
            -webkit-font-smoothing: none;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeSpeed;
            text-shadow: 0 1px 0 #000, 1px 0 0 #000, 0 -1px 0 #000, -1px 0 0 #000,
                         1px 1px 0 #000, -1px 1px 0 #000;
        }

        /* OKX style tags */
        .okx-chip {
            display: inline-block;
            padding: 6px 10px;
            background: rgba(17,17,17,0.8);
            border: 1px solid rgba(255,255,255,0.14);
            color: #ffffff;
            border-radius: 8px;
            font-size: 12px;
            letter-spacing: 0.8px;
            font-weight: 700;
            margin-bottom: 12px;
            font-family: 'Press Start 2P', 'VT323', 'SimHei', 'Microsoft YaHei', Arial, sans-serif;
            -webkit-font-smoothing: none;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeSpeed;
            text-shadow: 0 1px 0 #000, 1px 0 0 #000, 0 -1px 0 #000, -1px 0 0 #000,
                         1px 1px 0 #000, -1px 1px 0 #000;
        }

        /* ============== Chat Sidebar Styles ============== */
        .chat-toggle {
            position: fixed;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 3;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.55);
            color: #fff;
            cursor: pointer;
            backdrop-filter: blur(6px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
            font-family: 'Press Start 2P','VT323', 'Microsoft YaHei', Arial, sans-serif;
        }

        .chat-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: min(380px, 92vw);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 4;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.15);
            background: rgba(16,16,16,0.45);
            backdrop-filter: blur(14px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.55);
        }
        .chat-sidebar.open { transform: translateX(0); }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .chat-title { font-weight: 800; letter-spacing: .5px; font-family: 'Press Start 2P','VT323', 'Microsoft YaHei', Arial, sans-serif; }
        .icon-btn { border: none; background: transparent; color: #fff; font-size: 20px; cursor: pointer; }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px 10px 16px;
        }
        .msg { display: flex; margin: 8px 0; }
        .msg.self { justify-content: flex-end; }
        .bubble {
            max-width: 80%;
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
        }
        .msg.self .bubble { background: rgba(0,0,0,0.55); }
        .bubble .meta { font-size: 11px; color: #bdbdbd; margin-bottom: 4px; font-family: 'Press Start 2P','VT323', 'Microsoft YaHei', Arial, sans-serif; }
        .bubble .text { white-space: pre-wrap; word-break: break-word; font-family: 'Press Start 2P','VT323', 'Microsoft YaHei', Arial, sans-serif; }

        .chat-input-row {
            display: flex;
            gap: 8px;
            padding: 10px;
            border-top: 1px solid rgba(255,255,255,0.08);
            background: rgba(0,0,0,0.25);
            backdrop-filter: blur(8px);
        }
        .chat-input {
            flex: 1;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            background: rgba(0,0,0,0.35);
            color: #fff;
            padding: 10px 12px;
            outline: none;
            font-family: 'Press Start 2P','VT323', 'Microsoft YaHei', Arial, sans-serif;
        }
        .send-btn {
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 0 14px;
            background: rgba(0,0,0,0.55);
            color: #fff;
            cursor: pointer;
            font-family: 'Press Start 2P','VT323', 'Microsoft YaHei', Arial, sans-serif;
        }

        /* ============== Gacha Result Modal (Rarity Animation) ============== */
        .result-modal.hidden { display: none; }
        .result-modal { position: fixed; inset: 0; z-index: 6; }
        .result-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(3px); }
        .result-stage { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; padding: 16px; }
        .result-card {
            width: min(420px, 84vw);
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.16);
            /* Forward black and white checkerboard */
            background:
                conic-gradient(from 90deg,
                    rgba(255,255,255,0.12) 0 25%, transparent 0 50%,
                    rgba(255,255,255,0.12) 0 75%, transparent 0
                ) 0 0/18px 18px,
                rgba(0,0,0,0.8);
            box-shadow: 0 16px 48px rgba(0,0,0,0.58);
            padding: 14px 12px 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: resultPop .26s ease-out both;
        }
        @keyframes resultPop { from { transform: scale(.92); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .result-title { font-family: 'Press Start 2P','VT323','Microsoft YaHei',Arial,sans-serif; margin-bottom: 10px; }
        .result-item { display: inline-flex; flex-direction: column; align-items: center; gap: 8px; padding: 4px 0 2px; }
        .glass-badge { width: 160px; height: 160px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.32); background: rgba(255,255,255,0.08); backdrop-filter: blur(16px) saturate(120%); display: grid; place-items: center; position: relative; box-shadow: 0 8px 28px rgba(0,0,0,.5), inset 0 0 0 3px rgba(0,0,0,.25); }
        /* Unify circular borders to white, remove orange and other colored outlines */
        .rarity-mythic .glass-badge,
        .rarity-legendary .glass-badge,
        .rarity-epic .glass-badge,
        .rarity-rare .glass-badge,
        .rarity-uncommon .glass-badge,
        .rarity-common .glass-badge { border-color: rgba(255,255,255,0.32); }
        .result-symbol { font-size: 44px; line-height: 1; text-shadow: 0 2px 0 #000, 2px 0 0 #000, 0 -2px 0 #000, -2px 0 0 #000; }
        .result-name { font-size: 12px; color: #e0e0e0; font-family: 'Press Start 2P','VT323','Microsoft YaHei',Arial,sans-serif; }
        .result-actions { margin-top: 14px; display: flex; justify-content: center; gap: 10px; }
        .btn-ghost { border: 1px solid rgba(255,255,255,0.25); background: rgba(0,0,0,0.45); color: #fff; border-radius: 8px; padding: 6px 10px; cursor: pointer; font-family: 'Press Start 2P','VT323','Microsoft YaHei',Arial,sans-serif; backdrop-filter: blur(8px); }
        .btn-ghost:hover { background: rgba(255,255,255,0.08); }

        /* Result image (if provided) */
        .result-image { width: 76%; height: 76%; object-fit: cover; border-radius: 50%; image-rendering: pixelated; filter: drop-shadow(0 10px 30px rgba(0,0,0,.6)); display: none; }
        .rarity-mythic .result-image { width: 156px; height: 156px; }
        .rarity-legendary .result-image { width: 144px; height: 144px; }

        /* ============== Score Sidebar Styles (Right) ============== */
        .score-sidebar {
            position: fixed; right: 0; top: 0; bottom: 0; z-index: 4;
            width: min(340px, 92vw);
            transform: translateX(0);
            display: flex; flex-direction: column;
            border-left: 1px solid rgba(255,255,255,0.15);
            background: rgba(16,16,16,0.45); backdrop-filter: blur(14px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.55);
            padding: 10px 12px; color: #fff;
        }
        .score-header { display:flex; align-items:center; justify-content: space-between; padding: 6px 2px 10px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .score-title { font-weight: 800; letter-spacing: .5px; font-family: 'Press Start 2P','VT323','Microsoft YaHei',Arial,sans-serif; }
        .score-addr { font-size: 11px; color: #cfd8dc; word-break: break-all; }
        .score-body { padding: 10px 2px; display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }
        .score-section { border:1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; background: rgba(0,0,0,0.35); }
        .section-summary { }
        .section-feed { flex: 1; min-height: 120px; display: flex; flex-direction: column; }
        .section-rules { }
        .score-total { font-family: 'Press Start 2P','VT323','Microsoft YaHei',Arial,sans-serif; font-size: 26px; margin: 6px 0 10px; }
        .score-actions { display:flex; gap:8px; margin-bottom: 10px; }
        .score-subtitle { font-size: 12px; color: #cfd8dc; margin: 6px 0; }
        .score-feed { display:flex; flex-direction: column; gap:6px; overflow-y: auto; }
        .feed-item { display:flex; align-items:center; justify-content: space-between; gap:8px; border:1px solid rgba(255,255,255,0.1); border-radius: 10px; padding:6px 8px; background: rgba(0,0,0,0.35); }
        .feed-item .k { font-weight: 700; }
        .feed-item .p { color:#bdbdbd; font-size: 12px; }
        .rules-grid { display:none; }
        .rule-card { display:flex; align-items:center; gap:8px; border:1px solid rgba(255,255,255,0.1); border-radius: 10px; padding:6px 8px; background: rgba(0,0,0,0.35); }
        .rule-icon { width:28px; height:28px; border-radius: 50%; background:#111; background-size: cover; background-position: center; }
        .rule-label { font-size: 11px; }

        /* Contract address display */
        .section-ca { padding-bottom: 8px; }
        .ca-line { display:flex; align-items:flex-start; gap:8px; flex-wrap: nowrap; }
        .ca-text {
            font-family: 'Press Start 2P','VT323','Microsoft YaHei',Arial,sans-serif;
            font-size: 10px;
            line-height: 1.35;
            color:#e0e0e0;
            word-break: break-all;
            overflow-wrap: anywhere;
            white-space: normal;
            padding: 6px 8px;
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            flex: 1;
        }
        .btn-mini { padding: 4px 8px; font-size: 11px; flex-shrink: 0; }

        /* Bottom right overlay rules */
        .rules-overlay { display: none; }
        .rules-inline { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 6px 8px; align-items: center; padding: 6px 0 0; }
        .rules-inline .o-item { display:flex; align-items:center; gap:5px; }
        .rules-inline .o-icon { width:20px; height:20px; border-radius: 50%; background:#111; background-size: cover; background-position:center; }
        .rules-inline .o-text { font-size: 10px; line-height: 1; }
        .rules-overlay .o-item { display:flex; align-items:center; gap:6px; white-space: nowrap; }
        .rules-overlay .o-icon { width:22px; height:22px; border-radius: 50%; background:#111; background-size: cover; background-position:center; }
        .rules-overlay .o-text { font-size: 11px; }

        /* Rarity theme: unified white borders, remove colored outlines and glow */
        .rarity-mythic .result-card,
        .rarity-legendary .result-card,
        .rarity-epic .result-card,
        .rarity-rare .result-card,
        .rarity-uncommon .result-card,
        .rarity-common .result-card { border-color: rgba(255,255,255,0.16); box-shadow: 0 16px 48px rgba(0,0,0,0.58); }

        /* Particle and light effect container */
        .result-effects { pointer-events: none; position: absolute; inset: 0; overflow: hidden; }
        .confetti { position: absolute; width: 6px; height: 6px; opacity: .95; transform: translate3d(0,0,0); animation: fall linear forwards; box-shadow: 0 0 0 2px rgba(0,0,0,.4) inset; }
        @keyframes fall { to { transform: translate3d(var(--dx,0px), calc(100vh + 20px), 0) rotate(var(--rot,360deg)); opacity: .9; } }

        /* Light beams and pulse rings */
        .beam { position:absolute; left:50%; top:50%; width:2px; height:40vmin; transform-origin: center bottom; background: linear-gradient(to top, transparent, rgba(255,255,255,.9)); opacity:.9; mix-blend-mode: screen; }
        .ring { position:absolute; left:50%; top:50%; width:10vmin; height:10vmin; border:2px solid rgba(255,255,255,.8); border-radius:50%; transform: translate(-50%,-50%) scale(.2); opacity:0; animation: ringPulse 1.6s ease-out forwards; mix-blend-mode: screen; }
        @keyframes ringPulse { 20%{opacity:1} 100%{transform: translate(-50%,-50%) scale(2.6); opacity:0} }

        /* ============== Wallet Connect Styles ============== */
        .wallet-btn {
            position: fixed;
            top: 12px;
            right: 14px;
            z-index: 6;
            height: 38px;
            padding: 0 14px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.55);
            color: #fff;
            cursor: pointer;
            backdrop-filter: blur(6px);
            box-shadow: 0 10px 24px rgba(0,0,0,0.35);
            font-family: 'Press Start 2P','VT323','Microsoft YaHei',Arial,sans-serif;
        }
        .wallet-btn.connected { border-color: rgba(176,255,59,0.6); }

        .wallet-modal.hidden { display: none; }
        .wallet-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); backdrop-filter: blur(2px); z-index: 7; }
        .wallet-panel { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 8; padding: 16px; }
        .wallet-cardwrap { border: 1px solid rgba(255,255,255,0.12); background: rgba(16,16,16,0.45); backdrop-filter: blur(12px); padding: 14px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.55); min-width: 320px; max-width: 520px; width: 100%; }
        .wallet-header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
        .wallet-title { font-weight: 800; letter-spacing: .5px; font-family: 'Press Start 2P','VT323','Microsoft YaHei',Arial,sans-serif; }
        .wallet-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
        .wallet-card { display:flex; flex-direction:column; align-items:center; gap:8px; padding:16px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.35); color:#fff; cursor:pointer; }
        .wallet-card:hover { border-color: rgba(176,255,59,0.6); }
        .wallet-logo { width:42px; height:42px; border-radius:10px; background:#111; }
        .wallet-logo.okx { background: url('./image.png') center/cover no-repeat #000; border: 1px solid rgba(255,255,255,0.12); box-shadow: none; }
        .wallet-logo.metamask { background: url('./huli.png') center/cover no-repeat #000; border: 1px solid rgba(255,255,255,0.12); }
        .wallet-name { font-family: 'Press Start 2P','VT323','Microsoft YaHei',Arial,sans-serif; font-size:12px; }
        .wallet-desc { font-size:11px; color:#cfd8dc; }
        .wallet-tip { margin-top:10px; font-size:11px; color:#bdbdbd; text-align:center; }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .gacha-button {
                padding: 12px 25px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <canvas id="pixelBg"></canvas>
    <!-- Top right wallet connect button and modal -->
    <button id="walletBtn" class="wallet-btn" title="Connect Wallet">Connect Wallet</button>
    <div id="walletModal" class="wallet-modal hidden" aria-hidden="true">
        <div class="wallet-backdrop"></div>
        <div class="wallet-panel" role="dialog" aria-modal="true" aria-labelledby="walletModalTitle">
            <div class="wallet-cardwrap">
                <div class="wallet-header">
                    <div id="walletModalTitle" class="wallet-title">Select Wallet</div>
                    <button id="walletClose" class="icon-btn" aria-label="Close">×</button>
                </div>
                <div class="wallet-grid">
                    <button class="wallet-card" id="chooseOkx">
                        <div class="wallet-logo okx"></div>
                        <div class="wallet-name">OKX Wallet</div>
                        <div class="wallet-desc">Connect to X Layer</div>
                    </button>
                    <button class="wallet-card" id="chooseMetamask">
                        <div class="wallet-logo metamask"></div>
                        <div class="wallet-name">MetaMask</div>
                        <div class="wallet-desc">Connect to X Layer</div>
                    </button>
                </div>
                <div class="wallet-tip">Not installed? OKX: okx.com/web3 · MetaMask: metamask.io</div>
            </div>
        </div>
    </div>
    <!-- Side chat bar toggle button -->
    <button id="chatToggle" aria-label="Toggle Chat" title="Open/Hide Chat" class="chat-toggle">Chat</button>
    <!-- Right side score bar (bound to wallet address) -->
    <aside id="scoreSidebar" class="score-sidebar" aria-label="Score Sidebar">
        <div class="score-header">
            <div class="score-title">Score</div>
            <div id="scoreAddr" class="score-addr">Not Connected</div>
        </div>
        <div class="score-body">
            <section class="score-section section-summary">
                <div class="score-total" id="scoreTotal">0</div>
                <div class="score-actions">
                    <button id="claimBtn" class="btn-ghost">Claim Tokens</button>
                </div>
                <div class="score-subtitle">Contract Address</div>
                <div class="score-section section-ca">
                    <div class="ca-line">
                        <div id="caText" class="ca-text">soon
                        <button id="copyCaBtn" class="btn-ghost btn-mini">Copy</button>
                    </div>
                </div>
            </section>
            <section class="score-section section-feed">
                <div class="score-subtitle">Recent Records</div>
                <div id="scoreFeed" class="score-feed"></div>
            </section>
            <section class="score-section section-rules">
                <div class="score-subtitle">Game Rules · Draw = Points</div>
                <div id="scoreRules" class="rules-grid"></div>
                <div id="rulesInline" class="rules-inline"></div>
            </section>
        </div>
    </aside>
    <!-- Bottom right quick rules display -->
    <div id="rulesOverlay" class="rules-overlay"></div>

    <!-- Telegram style chat sidebar (can be hidden) -->
    <aside id="chatSidebar" class="chat-sidebar open" aria-label="Chat Sidebar">
        <div class="chat-header">
            <div class="chat-title">Chat Room</div>
            <div class="chat-actions">
                <button id="chatClose" class="icon-btn" title="Collapse">×</button>
            </div>
        </div>
        <div id="chatMessages" class="chat-messages" role="log" aria-live="polite"></div>
        <div class="chat-input-row">
            <input id="chatInput" class="chat-input" type="text" placeholder="Write something... Press Enter to send" maxlength="500" />
            <button id="chatSend" class="send-btn">Send</button>
        </div>
    </aside>
    <div class="container">
        <div class="video-container">
            <video id="gachaVideo" width="640" height="360" preload="metadata">
                <source src="生成扭蛋机动画.mp4" type="video/mp4">
                Your browser does not support video playback.
            </video>
            <div class="video-badge">Gachapon</div>
            <div class="meme-caption top" id="captionTop">Today spin for a billion</div>
            <div class="meme-caption bottom" id="captionBottom">ALL IN spin to the end</div>
        </div>
        
        <button class="gacha-button" id="gachaButton" onclick="playGacha()">Spin</button>
        
        <div class="status" id="status">Click the button to start gacha!</div>

        <h1 class="glitch">Gachapon Machine</h1>
        <div class="okx-chip">OKX VIBES • MEME MODE</div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getDatabase, ref as dbRef, push, onChildAdded, onValue, query, limitToLast, runTransaction, set } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js';
        // Firebase v9 modular initialization
        const firebaseConfig = {
            apiKey: "AIzaSyA5Z5ieEbAcfQX0kxGSn9ldGXhzvAwx_8M",
            authDomain: "chat-294cc.firebaseapp.com",
            databaseURL: "https://chat-294cc-default-rtdb.firebaseio.com",
            projectId: "chat-294cc",
            storageBucket: "chat-294cc.firebasestorage.app",
            messagingSenderId: "913615304269",
            appId: "1:913615304269:web:0274ffaccb8e6b678e4e04",
            measurementId: "G-SJR9NDW86B"
        };
        const appFb = initializeApp(firebaseConfig);
        const db = getDatabase(appFb);
        const fx = getFunctions(appFb, 'asia-east1');
        const video = document.getElementById('gachaVideo');
        const button = document.getElementById('gachaButton');
        const status = document.getElementById('status');
        const captionTop = document.getElementById('captionTop');
        const captionBottom = document.getElementById('captionBottom');
        let isPlaying = false;

        // Sound effects: 2.mp3 for drawing, 1.mp3 for winning
        const drawSfx = new Audio('./2.mp3');
        drawSfx.preload = 'auto';
        drawSfx.volume = 0.9;
        const winSfx = new Audio('./1.mp3');
        winSfx.preload = 'auto';
        winSfx.volume = 1.0;
        let drawSfxStopTimer = null;

        function startDrawSfx() {
            stopDrawSfx();
            try {
                drawSfx.currentTime = 0;
                drawSfx.play();
            } catch (e) {}
            // Drawing sound effect plays for maximum 4.5 seconds to avoid being too long
            drawSfxStopTimer = setTimeout(() => {
                drawSfx.pause();
                drawSfx.currentTime = 0;
            }, 4500);
        }

        function stopDrawSfx() {
            if (drawSfxStopTimer) { clearTimeout(drawSfxStopTimer); drawSfxStopTimer = null; }
            try { drawSfx.pause(); drawSfx.currentTime = 0; } catch (e) {}
        }

        function playWinSfx() {
            try { winSfx.currentTime = 0; winSfx.play(); } catch (e) {}
        }

        function playGacha() {
            if (!isPlaying) {
                // Start playing
                video.play();
                isPlaying = true;
                button.textContent = 'Pause';
                status.textContent = 'Let\'s spin! OKX MEME ON!';
                button.classList.add('spinning');
                captionTop.textContent = 'Let\'s go! WGMI';
                captionBottom.textContent = 'Bro trust me this is stable';
                startDrawSfx();
            } else {
                // Pause playing
                video.pause();
                isPlaying = false;
                button.textContent = 'Spin';
                status.textContent = 'Paused, continue ALL IN?';
                button.classList.remove('spinning');
                captionTop.textContent = 'Take a break';
                captionBottom.textContent = 'NGMI but fun';
                stopDrawSfx();
            }
        }

        // Handle when video playback ends
        video.addEventListener('ended', function() {
            stopDrawSfx();
            isPlaying = false;
            button.textContent = 'Spin Again';
            status.textContent = 'Gacha complete! Another round?';
            button.classList.remove('spinning');
            captionTop.textContent = 'To The Moon';
            captionBottom.textContent = 'One shot to the soul ✅';
        });

        // Handle when video metadata is loaded
        video.addEventListener('loadedmetadata', function() {
            status.textContent = 'Video loaded! Click the button to start gacha! 🎯';
        });

        // Handle when video starts playing
        video.addEventListener('play', function() {
            status.textContent = 'Gachapon machine is running...';
        });

        // Handle when video is paused
        video.addEventListener('pause', function() {
            if (!video.ended) {
                status.textContent = 'Gachapon machine paused, click to continue!';
            }
        });

        // Bind button click (in module environment, doesn't rely on inline onclick)
        button.addEventListener('click', playGacha);
        // Compatible with inline onclick calls
        window.playGacha = playGacha;

        // Click video can also play/pause
        video.addEventListener('click', function() {
            playGacha();
        });

        // Add keyboard shortcut support
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space') {
                event.preventDefault();
                playGacha();
            }
        });

        // Pixelated background rendering (using 2.png)
        (function () {
            const canvas = document.getElementById('pixelBg');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.src = './2.png';

            function draw() {
                const vw = window.innerWidth;
                const vh = window.innerHeight;
                canvas.width = vw;
                canvas.height = vh;
                if (!img.complete || img.naturalWidth === 0) {
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, vw, vh);
                    return;
                }

                // Calculate cover cropping
                const arImg = img.naturalWidth / img.naturalHeight;
                const block = Math.max(2, Math.floor(Math.min(vw, vh) / 120));
                const lowW = Math.max(32, Math.floor(vw / block));
                const lowH = Math.max(32, Math.floor(vh / block));
                const arView = lowW / lowH;
                let sx = 0, sy = 0, sw = img.naturalWidth, sh = img.naturalHeight;
                if (arImg > arView) {
                    sh = img.naturalHeight;
                    sw = sh * arView;
                    sx = (img.naturalWidth - sw) / 2;
                } else {
                    sw = img.naturalWidth;
                    sh = sw / arView;
                    sy = (img.naturalHeight - sh) / 2;
                }

                ctx.imageSmoothingEnabled = false;
                const off = document.createElement('canvas');
                off.width = lowW;
                off.height = lowH;
                const octx = off.getContext('2d');
                octx.imageSmoothingEnabled = true;
                octx.drawImage(img, sx, sy, sw, sh, 0, 0, lowW, lowH);
                ctx.drawImage(off, 0, 0, lowW, lowH, 0, 0, vw, vh);
            }

            img.onload = draw;
            window.addEventListener('resize', draw);
            draw();
        })();

        // ============== Chat Sidebar (Firebase Realtime Database) ==============
        // UI Controls
        const chatSidebar = document.getElementById('chatSidebar');
        const chatToggle = document.getElementById('chatToggle');
        const chatClose = document.getElementById('chatClose');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');

        function toggleChat() { chatSidebar.classList.toggle('open'); }
        function openChat() { chatSidebar.classList.add('open'); }
        function closeChat() { chatSidebar.classList.remove('open'); }
        chatToggle.addEventListener('click', toggleChat);
        chatClose.addEventListener('click', closeChat);

        // Save/get nickname
        function getUsername() {
            let u = localStorage.getItem('chat_username');
            if (!u) {
                u = prompt('Choose a name:') || ('User' + Math.floor(Math.random()*1000));
                localStorage.setItem('chat_username', u);
            }
            return u;
        }
        const username = getUsername();

        // Render message
        function renderMessage(msg) {
            const wrapper = document.createElement('div');
            const isSelf = msg.user === username;
            wrapper.className = 'msg ' + (isSelf ? 'self' : 'other');
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            const header = document.createElement('div');
            header.className = 'meta';
            header.textContent = (isSelf ? 'Me' : msg.user) + ' · ' + new Date(msg.ts || Date.now()).toLocaleTimeString();
            const text = document.createElement('div');
            text.className = 'text';
            text.textContent = msg.text || '';
            bubble.appendChild(header);
            bubble.appendChild(text);
            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;
            chatInput.value = '';
            const payload = { user: username, text, ts: Date.now() };
            push(dbRef(db, 'rooms/public/messages'), payload).catch((err)=>{ console.error(err); renderMessage(payload); });
        }
        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });

        // Subscribe to public chat room messages (Firebase v9 modular)
        onChildAdded(query(dbRef(db, 'rooms/public/messages'), limitToLast(200)), (snap) => {
            const data = snap.val();
            if (data) renderMessage(data);
        });

        // ============== Gacha Results: Probability and Reward Animation ==============
        // Reward configuration: symbol, name, rarity class, probability (weight)
        const REWARDS = [
            { key:'BTC',  name:'BTC',   icon:'₿',   img:'tokens/btc.png',  rarity:'mythic',     weight: 1  },   // 1%
            { key:'OKB',  name:'OKB',   icon:'OKB', img:'tokens/okb.png',  rarity:'legendary', weight: 5  },   // 5%
            { key:'ETH',  name:'ETH',   icon:'Ξ',   img:'tokens/eth.png',  rarity:'epic',       weight: 14 },   // 14%
            { key:'SOL',  name:'SOL',   icon:'◎',   img:'tokens/sol.png',  rarity:'rare',       weight: 50 },   // 50%
            { key:'BNB',  name:'BNB',   icon:'BNB', img:'tokens/bnb.png',  rarity:'uncommon',  weight: 10 },   // 10%
            { key:'USDT', name:'USDT',  icon:'₮',   img:'tokens/usdt.png', rarity:'common',     weight: 20 },   // 20%
        ];

        // Calculate weighted random
        function pickReward() {
            const total = REWARDS.reduce((s,r)=>s+r.weight,0);
            let r = Math.random()*total;
            for (const it of REWARDS){ if((r-=it.weight)<0) return it; }
            return REWARDS[REWARDS.length-1];
        }

        // Build result modal DOM
        const resultModal = document.createElement('div');
        resultModal.className = 'result-modal hidden';
        resultModal.innerHTML = `
            <div class="result-backdrop"></div>
            <div class="result-stage">
              <div class="result-card">
                <div class="result-effects" id="resultEffects"></div>
                <div class="result-title" id="resultTitle">Congratulations! You got</div>
                <div class="result-item">
                  <div class="glass-badge">
                    <img id="resultImg" class="result-image" alt="token" />
                    <div class="result-symbol" id="resultIcon">?</div>
                  </div>
                  <div class="result-name" id="resultName">???</div>
                </div>
                <div class="result-actions">
                  <button class="btn-ghost" id="btnAgain">Spin Again</button>
                  <button class="btn-ghost" id="btnCloseResult">Close</button>
                </div>
              </div>
            </div>`;
        document.body.appendChild(resultModal);

        const resultIcon = ()=>document.getElementById('resultIcon');
        const resultName = ()=>document.getElementById('resultName');
        const resultEffects = ()=>document.getElementById('resultEffects');
        const resultImg = ()=>document.getElementById('resultImg');
        const btnAgain = ()=>document.getElementById('btnAgain');
        const btnCloseResult = ()=>document.getElementById('btnCloseResult');

        function hideResult(){ resultModal.classList.add('hidden'); resultEffects().innerHTML=''; }
        function showResult(reward){
            const cls = `rarity-${reward.rarity}`;
            resultModal.className = `result-modal ${cls}`;
            // Try to display image
            const imgEl = resultImg();
            if (reward.img) {
                imgEl.src = reward.img;
                imgEl.onload = ()=>{ imgEl.style.display='block'; resultIcon().style.display='none'; };
                imgEl.onerror = ()=>{ imgEl.style.display='none'; resultIcon().style.display='block'; };
            } else { imgEl.style.display='none'; resultIcon().style.display='block'; }
            resultIcon().textContent = reward.icon;
            resultName().textContent = reward.name;
            // Generate different amounts/speeds of confetti and light effects based on rarity
            spawnEffects(reward.rarity);
        }

        function spawnEffects(rarity){
            const container = resultEffects();
            const confettiCount = ({mythic:150, legendary:120, epic:90, rare:60, uncommon:40, common:20})[rarity]||30;
            for(let i=0;i<confettiCount;i++){
                const c = document.createElement('div');
                c.className='confetti';
                const hue = ({mythic:[48,60], legendary:[90,120], epic:[190,210], rare:[25,35], uncommon:[140,160], common:[0,360]})[rarity]||[0,360];
                const h = Math.random()*(hue[1]-hue[0])+hue[0];
                c.style.background = `hsl(${h} 90% 60%)`;
                c.style.left = Math.random()*100 + 'vw';
                c.style.top = '-20px';
                c.style.setProperty('--dx', (Math.random()*200-100)+'px');
                c.style.setProperty('--rot', (Math.random()*720-360)+'deg');
                c.style.animationDuration = (8 - Math.min(6, i%6)) + 's';
                container.appendChild(c);
            }
            // Light beams
            const beams = ({mythic:16, legendary:12, epic:8, rare:4, uncommon:2, common:0})[rarity]||0;
            for(let i=0;i<beams;i++){
                const b = document.createElement('div');
                b.className='beam';
                const a = (360/beams)*i + Math.random()*10;
                b.style.transform = `translate(-50%, -100%) rotate(${a}deg)`;
                b.style.height = (30 + Math.random()*30) + 'vmin';
                container.appendChild(b);
            }
            // Pulse rings
            const rings = ({mythic:6, legendary:5, epic:4, rare:3, uncommon:2, common:1})[rarity]||1;
            for(let i=0;i<rings;i++){
                const r = document.createElement('div');
                r.className='ring';
                r.style.animationDelay = (i*0.25)+'s';
                container.appendChild(r);
            }
        }

        // 将“播放结束”与“再扭一次”接入抽奖逻辑
        video.addEventListener('ended', function(){
            const reward = pickReward();
            showResult(reward);
            playWinSfx();
            // Write score
            addScoreForReward(reward);
            // Maintain original end state updates
            isPlaying = false; button.textContent='Spin Again'; status.textContent='Gacha complete! Another round?'; button.classList.remove('spinning'); captionTop.textContent='To The Moon'; captionBottom.textContent='One shot to the soul ✅';
        });

        // “再扭一次”按钮直接重新播放
        document.addEventListener('click', (e)=>{
            if(e.target && e.target.id==='btnAgain'){ hideResult(); playGacha(); }
            if(e.target && e.target.id==='btnCloseResult'){ hideResult(); }
        });

        // ============== Connect Wallet (OKX / MetaMask → X Layer) ==============
        const walletBtn = document.getElementById('walletBtn');
        const walletModal = document.getElementById('walletModal');
        const walletClose = document.getElementById('walletClose');
        const chooseOkx = document.getElementById('chooseOkx');
        const chooseMetamask = document.getElementById('chooseMetamask');

        function openWalletModal() { walletModal.classList.remove('hidden'); }
        function closeWalletModal() { walletModal.classList.add('hidden'); }
        walletBtn.addEventListener('click', openWalletModal);
        document.querySelector('.wallet-backdrop').addEventListener('click', closeWalletModal);
        walletClose.addEventListener('click', closeWalletModal);

        // X Layer mainnet parameters (chainId: 196 -> 0xC4)
        const X_LAYER_PARAMS = {
            chainId: '0xC4',
            chainName: 'X Layer Mainnet',
            rpcUrls: ['https://rpc.xlayer.tech'],
            nativeCurrency: { name: 'OKB', symbol: 'OKB', decimals: 18 },
            blockExplorerUrls: ['https://www.oklink.com/xlayer']
        };

        async function switchToXLayer(provider) {
            try {
                await provider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: X_LAYER_PARAMS.chainId }] });
            } catch (err) {
                // If network not added, try to add it
                if (err && err.code === 4902) {
                    await provider.request({ method: 'wallet_addEthereumChain', params: [X_LAYER_PARAMS] });
                } else {
                    throw err;
                }
            }
        }

        async function connectOkx() {
            const okx = window.okxwallet || window.okxwallet?.ethereum || window.okxwallet?.providers?.ethereum;
            if (!okx) {
                window.open('https://www.okx.com/web3', '_blank');
                return;
            }
            try {
                await okx.request({ method: 'eth_requestAccounts' });
                await switchToXLayer(okx);
                walletBtn.textContent = 'Connected OKX';
                walletBtn.classList.add('connected');
                closeWalletModal();
            } catch (e) { console.error(e); }
        }

        async function connectMetamask() {
            const mm = (window.ethereum && (!window.okxwallet || window.ethereum.isMetaMask)) ? window.ethereum : (window.ethereum?.providers?.find(p => p.isMetaMask) || null);
            if (!mm) { window.open('https://metamask.io', '_blank'); return; }
            try {
                await mm.request({ method: 'eth_requestAccounts' });
                await switchToXLayer(mm);
                walletBtn.textContent = 'Connected MetaMask';
                walletBtn.classList.add('connected');
                closeWalletModal();
            } catch (e) { console.error(e); }
        }

        chooseOkx.addEventListener('click', connectOkx);
        chooseMetamask.addEventListener('click', connectMetamask);

        // ============== Right sidebar: Score and Claim (Firebase bound to wallet address) ==============
        const scoreAddrEl = document.getElementById('scoreAddr');
        const scoreTotalEl = document.getElementById('scoreTotal');
        const scoreFeedEl = document.getElementById('scoreFeed');
        const claimBtn = document.getElementById('claimBtn');
        let currentAddress = null;

        // Map rewards -> points (from high to low: 100k, 25k, 3k, 1k, 500)
        const SCORE_MAP = {
            mythic: 100000,
            legendary: 25000,
            epic: 3000,
            rare: 1000,
            uncommon: 500,
            common: 500,
        };

        // Bind address display
        function setAddress(addr){ currentAddress = addr; scoreAddrEl.textContent = addr ? (addr.slice(0,6)+'...'+addr.slice(-4)) : 'Not Connected'; if(addr){ loadScore(addr); } }

        // When wallet connection is successful, set the address
        const originalConnectOkx = connectOkx;
        const originalConnectMetamask = connectMetamask;

        async function connectOkxWrapped(){ await originalConnectOkx(); try{ const okx = window.okxwallet || window.okxwallet?.ethereum; const accs = await okx.request({method:'eth_accounts'}); setAddress(accs?.[0]||null);}catch(e){} }
        async function connectMetamaskWrapped(){ await originalConnectMetamask(); try{ const mm = window.ethereum; const accs = await mm.request({method:'eth_accounts'}); setAddress(accs?.[0]||null);}catch(e){} }

        // Override event binding
        chooseOkx.removeEventListener('click', connectOkx);
        chooseOkx.addEventListener('click', connectOkxWrapped);
        chooseMetamask.removeEventListener('click', connectMetamask);
        chooseMetamask.addEventListener('click', connectMetamaskWrapped);
        // Initial render of bottom right rules (no wallet connection needed)
        renderRulesOverlay();

        // Firebase: Use Realtime Database to store scores (modular)
        function userRef(addr){ return dbRef(db, 'users/'+addr.toLowerCase()); }
        function scoreRef(addr){ return dbRef(db, 'users/'+addr.toLowerCase()+'/score'); }
        function feedRef(addr){ return dbRef(db, 'users/'+addr.toLowerCase()+'/feed'); }

        function loadScore(addr){
            onValue(scoreRef(addr), snap => {
                const total = Number(snap.val() || 0);
                scoreTotalEl.textContent = total;
                if (claimBtn) { claimBtn.disabled = !currentAddress || total <= 0; }
            });
            onChildAdded(query(feedRef(addr), limitToLast(50)), snap => {
                const it = snap.val();
                const row = document.createElement('div');
                row.className = 'feed-item';
                row.innerHTML = `<span class="k">${it.token || it.rarity}</span><span class="p">+${it.points}</span>`;
                scoreFeedEl.prepend(row);
            });
            // 渲染玩法与积分对应
            renderRules();
        }

        async function addScoreForReward(reward){
            if(!currentAddress) return;
            const points = SCORE_MAP[reward.rarity] || 0;
            const addr = currentAddress.toLowerCase();
            const sRef = scoreRef(addr);
            const fRef = feedRef(addr);
            await runTransaction(sRef, v => (v||0) + points);
            await push(fRef, { ts: Date.now(), token: reward.name, rarity: reward.rarity, points });
        }

        // Game rules rendering (token image + equals how many points)
        function renderRules(){
            const grid = document.getElementById('scoreRules');
            if(!grid) return;
            grid.innerHTML = '';
            const ICONS = {
                BTC: 'tokens/btc.png', OKB: 'tokens/okb.png', ETH: 'tokens/eth.png',
                SOL: 'tokens/sol.png', BNB: 'tokens/bnb.png', USDT: 'tokens/usdt.png'
            };
            const order = ['BTC','OKB','ETH','SOL','BNB','USDT'];
            for(const key of order){
                const reward = REWARDS.find(r=>r.key===key);
                if(!reward) continue;
                const points = SCORE_MAP[reward.rarity]||0;
                const card = document.createElement('div');
                card.className = 'rule-card';
                const icon = document.createElement('div');
                icon.className = 'rule-icon';
                const url = ICONS[key] || reward.img;
                if(url) icon.style.backgroundImage = `url('${url}')`;
                const label = document.createElement('div');
                label.className = 'rule-label';
                label.textContent = `${key} = ${points}`;
                card.appendChild(icon); card.appendChild(label);
                grid.appendChild(card);
            }
            // Synchronize bottom right overlay
            renderRulesOverlay();
        }

        function renderRulesOverlay(){
            const overlay = document.getElementById('rulesOverlay');
            const inline = document.getElementById('rulesInline');
            const targets = [overlay, inline].filter(Boolean);
            targets.forEach(t => t.innerHTML = '');
            const order = ['BTC','OKB','ETH','SOL','BNB','USDT'];
            const ICONS = { BTC:'tokens/btc.png', OKB:'tokens/okb.png', ETH:'tokens/eth.png', SOL:'tokens/sol.png', BNB:'tokens/bnb.png', USDT:'tokens/usdt.png' };
            for(const key of order){
                const reward = REWARDS.find(r=>r.key===key);
                if(!reward) continue;
                const points = SCORE_MAP[reward.rarity]||0;
                const build = (inlineMode=false) => {
                    const item = document.createElement('div'); item.className= inlineMode ? 'o-item' : 'o-item';
                    const ic = document.createElement('div'); ic.className= inlineMode ? 'o-icon' : 'o-icon'; const url = ICONS[key] || reward.img; if(url) ic.style.backgroundImage = `url('${url}')`;
                    const tx = document.createElement('div'); tx.className= inlineMode ? 'o-text' : 'o-text'; tx.textContent = `${key}=${points}`;
                    item.appendChild(ic); item.appendChild(tx); return item;
                };
                targets.forEach(t => t && t.appendChild(build(t===inline)));
            }
        }

        // Claim tokens: Call cloud function convertPointsToToken (1 point = 1 token)
        claimBtn.addEventListener('click', async ()=>{
            if(!currentAddress){ alert('Please connect wallet first'); return; }
            const total = Number(scoreTotalEl.textContent || 0);
            if (total <= 0) { alert('Current score is 0'); return; }
            try {
                claimBtn.disabled = true; claimBtn.textContent = 'Claiming...';
                const convert = httpsCallable(fx, 'convertPointsToToken');
                const res = await convert({ address: currentAddress });
                const data = res && res.data ? res.data : {};
                if (data.ok) {
                    alert('Claim successful!\nTx: ' + data.txHash);
                    // Local refresh score (cloud function already cleared)
                    await set(scoreRef(currentAddress.toLowerCase()), 0);
                } else {
                    alert('Claim failed: ' + (data.error || 'UNKNOWN'));
                }
            } catch (e) {
                alert('Call failed: ' + (e.message || e));
            } finally {
                claimBtn.textContent = 'Claim Tokens';
                const total2 = Number(scoreTotalEl.textContent || 0);
                claimBtn.disabled = !currentAddress || total2 <= 0;
            }
        });
        // Contract address copy
        const copyBtn = document.getElementById('copyCaBtn');
        const caTextEl = document.getElementById('caText');
        if (copyBtn && caTextEl) {
            copyBtn.addEventListener('click', async ()=>{
                const ca = (caTextEl.textContent || '').trim();
                try {
                    await navigator.clipboard.writeText(ca);
                    copyBtn.textContent = 'Copied';
                    setTimeout(()=>{ copyBtn.textContent = 'Copy'; }, 1200);
                } catch (e) {
                    const tmp = document.createElement('textarea');
                    tmp.value = ca;
                    document.body.appendChild(tmp);
                    tmp.select();
                    document.execCommand('copy');
                    document.body.removeChild(tmp);
                    copyBtn.textContent = 'Copied';
                    setTimeout(()=>{ copyBtn.textContent = 'Copy'; }, 1200);
                }
            });
        }
    </script>
    
</body>
</html>
